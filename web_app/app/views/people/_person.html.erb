<tr class="person" id="<%= person.id %>">
  <td class="p_first_name"><%= (@contestant and person.is_helper_for?(@contestant)) ? "* " : "" %><%=h person.first_name %></td>
  <td class="p_last_name"><%=h person.last_name %></td>
  <% if logged_in? -%>
  <td class="p_email"><%=h person.email %></td>
  <% end -%>

  <% unless @contestant # don't show these infos on contestant page -%>
    <td id="p_teams_<%= person.id %>" class="person_teams">
      <% unless person.teams.visible.empty? %>
          <abbr class="tooltipped">In <span class="team_count"><%= person.teams.visible.count.to_s %></span> Team(s)</abbr> 
          <div class="tooltip">
            <% person.teams.visible.each do |team| %>
              <ul class="team <%= team.contests.map{|c| c.subdomain}.join(" ") %>" style="margin-left: 15px">
                <li>
                  <span><%= team.name %></span> (<%= t "views.as" %> <span><%= person.membership_for(team).role %></span>)
                </li>
              </ul>
            <% end %>
          </div>
      <% end %>
      <% locations = person.contestants.map{|c| c.location} %>
      <% locations = locations.join(";") %>
      <span id="person_location_<%= person.id %>" style="display: none"><%= locations %></span>  
      <% roles = [] %>
      <% if person.has_role?(:administrator) then roles << "administrator" end %>
      <% person.teams.each do |team| %>
        <% person.roles_for(team).each do |role| %>
          <% roles << role.name %>
        <% end %>
      <% end %>
      <% rolestr = "" %>
      <% roles.uniq.each_with_index do |role,index| %>
        <% rolestr += (index > 0 ? ";" : "") + role %>
      <% end %>
      <% teamstr = person.teams.collect(&:name).join(";") %>
      <span id="team_text_<%= person.id %>" style="display: none"><%= teamstr %></span>
      <span id="role_text_<%= person.id %>" style="display: none"><%= rolestr %></span>
    </td>

    <% show_to :administrator do %>
      <td class="p_administrator">
        <%=t person.has_role?(:administrator).to_s %>
      </td>
    <% end %>
  <% end -%>
  <td>
    <% if may_see_person_details? :person => person -%>
    <% show_image = image_tag "actions/show.png", :title => I18n.t("actions.show"), :class => "tooltipped" %>
    <%= link_to show_image, [@context, @contestant, person] %>
    <% end -%>
  </td>
  <% if @contestant -%>
    <td>
      <% if current_user.has_role? :administrator or same_person(person) or (current_user.manageable_teams.include?(@contestant) and ["pupil", "teacher"].include?(person.membership_for(@contestant).role.name)) -%>
      <% edit_image = image_tag "actions/edit.png", :title => I18n.t("actions.edit"), :class => "tooltipped" %>
      <%= link_to edit_image, [:edit, @context, @contestant, person] %>
      <% end -%>
    </td>
    <td>
      <% if may_remove_from_contestant? -%>
        <% remove_image = image_tag "actions/remove_small.png", :title => I18n.t("actions.remove_from_contestant"), :class => "tooltipped" %>
        <%= link_to remove_image, [:remove, @context, @contestant, person], :confirm => I18n.t("messages.confirm_remove_from_contestant", :name => person.name), :method => :post %>
      <% end -%>
    </td>
  <% else -%>
    <td>
      <% if current_user.has_role? :administrator or same_person(person) -%>
      <% edit_image = image_tag "actions/edit.png", :title => I18n.t("actions.edit"), :class => "tooltipped" %>
      <%= link_to edit_image, [:edit, @context, person] %>
      <% end -%>
    </td>
    <td>
      <% show_to :administrator do -%>
        <% unless person.hidden -%>
          <% if person != current_user %>
            <% delete_image = image_tag "actions/delete.png", :title => I18n.t("actions.delete"), :class => "tooltipped" %>
            <%= link_to delete_image, [:hide, @context, person], :confirm => I18n.t("messages.confirm_hiding", :name => person.name) %>
          <% end %>
        <% else %>
        <% undelete_image = image_tag "actions/undo.gif", :title => I18n.t("actions.unhide"), :class => "tooltipped" %>
        <%= link_to undelete_image, [:unhide, @context, person] %>
        <% end -%>
      <% end -%>
    </td>
  <% end -%>
</tr>
